# 2025-10-14 - Loki 監控的核心概念與 SLI 指標詳解 (費曼學習法)

> **TL;DR:** 監控 Loki 不只是看 CPU 和 Memory，而是要定義服務等級目標 (SLO)，並圍繞它建立指標 (SLI)。核心是理解 `_count`, `_sum`, `_bucket` 這三個指標家族如何衍生出 QPS、延遲和錯誤率。

---

## 🌍 WHY - 核心問題
為什麼 `sum(rate(loki_request_duration_seconds_count[5m]))` 這個查詢，一下子是 QPS，一下子又變成錯誤率或成功率公式的一部分？這讓人非常困惑，搞不清楚一個指標的真實意義。

---

## 💡 THE BIG IDEA - 核心類比：醫院的「病患掛號單」

把 Loki 的 `loki_request_duration_seconds` 指標家族，想像成一家醫院掛號櫃檯的**掛號紀錄單**。每當一個請求 (病患) 進來，系統就會在這張單上記錄三件事：

1.  `_count`: **掛號總人數** +1。(這是個計數器)
2.  `_sum`: **總等待時間** 加上這位病患的等待時間。(也是計數器)
3.  `_bucket`: 在對應的「等待時間區間」格子裡打勾 ✔️。(例如：`le="5秒"` 的格子記錄等候小於等於 5 秒的人數)

有了這張萬能掛號單，我們就能回答各種關於醫院營運狀況的問題：

---

## 🧩 WHAT - 核心概念拆解

_(現在，將上面的類比，逐一對應到技術術語上)_

- **Request Rate (QPS)** (類比中的**每秒掛號人數**):
    - **算法:** `rate(_count[5m])`
    - **解釋:** `_count` 是總人數，對它取 `rate` 就是計算「每秒」新來了多少人，這就是 QPS (每秒請求數)。

- **Average Latency (平均延遲)** (類比中的**平均每人等多久**):
    - **算法:** `rate(_sum[5m]) / rate(_count[5m])`
    - **解釋:** 平均等待時間 = (每秒增加的總等待時間) / (每秒新來的人數)。單位是秒。

- **Error Rate (錯誤率)** (類比中的**掛錯號的比率**):
    - **算法:** `rate(_count{status_code!~"2.."}[5m]) / rate(_count[5m])`
    - **解釋:** 掛錯號的人數 / 總掛號人數。`status_code!~"2.."` 就是篩選出那些「掛錯號」的人。

- **P95 Latency (95百分位延遲)** (類比中的**95%的病患最多等多久**):
    - **算法:** `histogram_quantile(0.95, sum by(le)(rate(_bucket[5m])))`
    - **解釋:** 查看 `_bucket` 上各個時間區間的打勾分佈，來估算出一個時間點，能保證 95% 的病患等待時間都比它短。這比「平均值」更能反映大多數人的真實體感。

- **Service Level Objective (SLO) (服務等級目標)** (類比中的**醫院院長的承諾**):
    - **解釋:** 院長對外承諾：「我們醫院，這個月要確保 **99.9%** 的病患都能成功掛號，並且 **95%** 的人等待時間不超過 **5秒**。」這就是 SLO。
    - **Error Budget (誤差預算):** 院長也知道不可能 100% 完美，所以允許有 `1 - 99.9% = 0.1%` 的失敗空間。這就是我們可以「燒掉」的預算。
    - **Burn Rate (預算燃燒率):** 如果燒預算的速度太快，就可能月底不達標。`Fast Burn` (短時間大爆炸) 和 `Slow Burn` (慢性問題) 告警就是用來監控這個燃燒率的。

---

## 🤔 LEARNING GAPS - 我卡關的地方

- **指標的單位混淆：** 一開始沒搞懂 `rate(_sum)` 的單位是 `秒/秒`，而不是 `秒`。必須除以 `rate(_count)` (請求/秒) 才能得到真正的平均延遲 (秒)。
- **P95 和 P99 的選擇：** P95 反映大眾體感，適合做 SLO；P99 對長尾更敏感，但低流量時抖動劇烈，適合用於深入排查而非主要告警。