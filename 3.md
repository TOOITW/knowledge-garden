# 2025-10-14 - å»ºç«‹ Loki ç”Ÿç”¢ç´šç›£æ§å„€è¡¨æ¿å¯¦æˆ°ç­†è¨˜

**Tags:** #loki #grafana #prometheus #promql #slo #troubleshooting #learning
**Status:** #Evergreen
**Related:** [[MOC: Grafana Loki ç”Ÿç”¢ç´šç›£æ§]], [[2025-10-14 - Loki ç›£æ§çš„æ ¸å¿ƒæ¦‚å¿µèˆ‡ SLI æŒ‡æ¨™è©³è§£ (è²»æ›¼å­¸ç¿’æ³•)]]

---

## ğŸ¯ æƒ…å¢ƒ (Context / Goal)
åœ¨ Loki éƒ¨ç½²å®Œæˆå¾Œï¼Œéœ€è¦å»ºç«‹ä¸€å¥—ç”Ÿç”¢ç´šçš„ Grafana ç›£æ§å„€è¡¨æ¿ã€‚ç›®æ¨™ä¸åƒ…æ˜¯è§€å¯Ÿè³‡æºä½¿ç”¨ç‡ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹ä¸€å¥—åœç¹æœå‹™ç­‰ç´šç›®æ¨™ (SLO) çš„å¯ç”¨æ€§ç›£æ§ï¼Œä¸¦è¨­å®šæœ‰æ•ˆå‘Šè­¦ã€‚

## ğŸ” å•é¡Œç¾è±¡ / æ ¸å¿ƒå…§å®¹ (Problem / Core Content)
åœ¨å»ºç«‹å„€è¡¨æ¿çš„éç¨‹ä¸­ï¼Œé‡åˆ°äº†ä»¥ä¸‹å¹¾å€‹é—œéµå•é¡Œï¼š
1.  **Job Label é¸æ“‡æ··äº‚ï¼š** ä¸ç¢ºå®šè©²é¸æ“‡ `loki-direct` é‚„æ˜¯ `observability/loki-read/write`ã€‚
2.  **éŒ¯èª¤ç‡ç•°å¸¸é«˜ï¼š** Error Rate åœ–è¡¨é¡¯ç¤º 30-40%ï¼Œä½†æª¢æŸ¥ 4xx/5xx éŒ¯èª¤ç¢¼å»æ˜¯ 0ã€‚
3.  **Cache å‘½ä¸­ç‡æŸ¥ç„¡è³‡æ–™ï¼š** ç„¡æ³•æ‰¾åˆ° `loki_cache_misses_total` æŒ‡æ¨™ï¼Œå°è‡´å‘½ä¸­ç‡å…¬å¼å¤±æ•ˆã€‚
4.  **é›™æ™‚é–“çª—æ›²ç·šé‡ç–Šï¼š** åœ¨åŒä¸€å€‹é¢æ¿æ”¾ 5m å’Œ 1h çš„éŒ¯èª¤ç‡æŸ¥è©¢ï¼Œå»åªé¡¯ç¤ºä¸€æ¢ç·šã€‚

## ğŸ› ï¸ åˆ†æèˆ‡è§£æ±ºæ–¹æ¡ˆ (Analysis & Solution)

### 1. Job Label çš„æ­£ç¢ºé¸æ“‡ (Read vs. Write)
- **åˆ†æ:** åœ¨ `SimpleScalable` éƒ¨ç½²æ¨¡å¼ä¸‹ï¼ŒLoki çš„è®€ã€å¯«è·¯å¾‘æ˜¯ç”±ä¸åŒçš„ Pod é›†åˆè² è²¬çš„ã€‚
- **æ ¹æœ¬åŸå› :** `loki-direct` é©ç”¨æ–¼å–®é«” (Monolithic) éƒ¨ç½²ã€‚å°æ–¼ `SimpleScalable` æˆ– `Microservices` æ¨¡å¼ï¼Œå¿…é ˆåˆ†é–‹ç›£æ§è®€å’Œå¯«ã€‚
- **æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ:**
    - **è®€å–è·¯å¾‘ (æŸ¥è©¢å¯ç”¨æ€§):** ä½¿ç”¨ `{job="observability/loki-read"}`
    - **å¯«å…¥è·¯å¾‘ (æ—¥èªŒæ¥æ”¶å¯ç”¨æ€§):** ä½¿ç”¨ `{job="observability/loki-write"}`
    - **çµè«–:** åˆ†é–‹ç›£æ§èƒ½æ›´å¿«åœ°å®šä½æ˜¯æŸ¥è©¢æ…¢é‚„æ˜¯å¯«å…¥å¡ä½ã€‚

### 2. ä¿®æ­£è™›é«˜çš„éŒ¯èª¤ç‡
- **åˆ†æ:** éŒ¯èª¤ç‡å…¬å¼ `status_code!~"2.."` å°‡æ²’æœ‰ `status_code` æ¨™ç±¤çš„å…§éƒ¨ gRPC æˆ–å¥åº·æª¢æŸ¥è«‹æ±‚ä¹Ÿèª¤åˆ¤ç‚ºéŒ¯èª¤ã€‚
- **æ ¹æœ¬åŸå› :** Loki æŒ‡æ¨™ä¸­ï¼Œä¸¦éæ‰€æœ‰è«‹æ±‚çš„ time series éƒ½å¸¶æœ‰ `status_code` æ¨™ç±¤ã€‚
- **æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ (ç©©å¥ç‰ˆ PromQL):**
    ```promql
    100 * sum(rate(loki_request_duration_seconds_count{job="observability/loki-read", route=~"loki_api_v1_.*", status_code!="", status_code!~"2.."}[5m]))
    /
    sum(rate(loki_request_duration_seconds_count{job="observability/loki-read", route=~"loki_api_v1_.*", status_code!=""}[5m]))
    ```
    - **`status_code!=""`**: é€™æ˜¯é—œéµï¼Œå®ƒæ’é™¤äº†æ‰€æœ‰ä¸å¸¶ `status_code` æ¨™ç±¤çš„ seriesï¼Œé¿å…èª¤ç®—ã€‚
    - **`route=~"loki_api_v1_.*"`**: é€²ä¸€æ­¥å°‡ç›£æ§ç¯„åœç¸®å°åˆ°çœŸæ­£çš„å°å¤– APIï¼Œæ’é™¤ `/ready`, `/metrics` ç­‰å…§éƒ¨è·¯ç”±çš„å¹²æ“¾ã€‚

### 3. æ‰¾åˆ°æ­£ç¢ºçš„ Cache æŒ‡æ¨™
- **åˆ†æ:** æœ€åˆçš„ `loki_cache_misses_total` æŸ¥ç„¡è³‡æ–™ï¼Œä½†é€šé `Metrics explore` é€æ­¥æ’æŸ¥ï¼Œç™¼ç¾äº†æ›´ç²¾ç¢ºçš„æŒ‡æ¨™åç¨±ã€‚
- **æ ¹æœ¬åŸå› :** Loki çš„æŒ‡æ¨™åç¨±åœ¨ä¸åŒç‰ˆæœ¬æˆ–çµ„ä»¶ä¸­å¯èƒ½å­˜åœ¨å·®ç•°ã€‚
- **æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ:**
    - **`hit` æŒ‡æ¨™:** `loki_query_frontend_log_result_cache_hit_total`
    - **`miss` æŒ‡æ¨™:** `loki_query_frontend_log_result_cache_miss_total`
    - **ç©©å¥ç‰ˆ Cache å‘½ä¸­ç‡ PromQL (0-100%):**
    ```promql
    100 *
    sum(rate(loki_query_frontend_log_result_cache_hit_total{job="observability/loki-read"}[5m]))
    /
    clamp_min(
      sum(rate(loki_query_frontend_log_result_cache_hit_total{job="observability/loki-read"}[5m]))
    + sum(rate(loki_query_frontend_log_result_cache_miss_total{job="observability/loki-read"}[5m]))
    , 1)
    ```
    - **`clamp_min(..., 1)`**: é¿å…åœ¨æµé‡æ¥µä½æ™‚åˆ†æ¯ç‚º 0 å°è‡´æŸ¥è©¢å¤±æ•—ã€‚

### 4. è®“é›™æ™‚é–“çª—æ›²ç·šåŒæ™‚é¡¯ç¤º
- **åˆ†æ:** çŸ­æ™‚é–“ç¯„åœå…§ï¼ˆå¦‚ 15 åˆ†é˜ï¼‰ï¼Œ5m å’Œ 1h çª—å£è¨ˆç®—å‡ºçš„éŒ¯èª¤ç‡å¹¾ä¹å®Œå…¨ç›¸åŒï¼Œå°è‡´æ›²ç·šé‡ç–Šã€‚
- **æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ:**
    - **æ‹‰é•·æ™‚é–“ç¯„åœï¼š** å°‡ Grafana çš„æ™‚é–“ç¯„åœèª¿æ•´ç‚º `Last 6 hours` æˆ–æ›´é•·ï¼Œå…©å€‹çª—å£çš„å¹³æ»‘åº¦å·®ç•°å°±æœƒé¡¯ç¾å‡ºä¾†ã€‚
    - **æ˜ç¢ºåœ–ä¾‹ (Legend):** ç‚ºå…©å€‹æŸ¥è©¢åˆ†åˆ¥è¨­ç½®åœ–ä¾‹ï¼Œä¾‹å¦‚ `err_5m` å’Œ `err_1h`ã€‚
    - **æª¢æŸ¥ NaNï¼š** åœ¨åˆ†æ¯ä¸­ä½¿ç”¨ `clamp_min` å‡½æ•¸å¯ä»¥é˜²æ­¢å› æµé‡ç‚ºé›¶ç”¢ç”Ÿ `NaN` å€¼ï¼Œç¢ºä¿æ›²ç·šä¸æœƒä¸­æ–·ã€‚

## ğŸ’¡ ç¸½çµèˆ‡å»¶ä¼¸ (Key Takeaways & Next Steps)
- **é—œéµå•Ÿç¤º:**
    - **æŒ‡æ¨™æ¢ç´¢æ˜¯å¿…è¦çš„:** ä¸è¦å®Œå…¨ç›¸ä¿¡æ–‡æª”æˆ–ç¯„ä¾‹ï¼Œå‹™å¿…ä½¿ç”¨ `Metrics explore` å’Œ `label_values()` å‡½æ•¸ä¾†é©—è­‰æ‚¨ç’°å¢ƒä¸­å¯¦éš›å­˜åœ¨çš„æŒ‡æ¨™åç¨±å’Œæ¨™ç±¤ã€‚
    - **PromQL çš„ç©©å¥æ€§å¾ˆé‡è¦:** ä½¿ç”¨ `status_code!=""` å’Œ `clamp_min()` ç­‰æŠ€å·§å¯ä»¥è®“æ‚¨çš„æŸ¥ã„Šè©¢åœ¨å„ç¨®é‚Šç•Œæ¢ä»¶ä¸‹ï¼ˆå¦‚ä½æµé‡ã€æ¨™ç±¤ç¼ºå¤±ï¼‰ä¾ç„¶å¯é ã€‚
    - **é¢æ¿å®Œæ•´æ€§:** ä¸€å€‹å®Œæ•´çš„å¯ç”¨æ€§ç›£æ§ä¸åƒ…è¦æœ‰å»¶é²å’ŒéŒ¯èª¤ç‡ï¼Œé‚„æ‡‰è£œå…… **Burn-rate å‘Šè­¦**ã€**ç„¡æµé‡å‘Šè­¦** å’Œ **Cache å‘½ä¸­ç‡** ç­‰ï¼Œä»¥å¯¦ç¾å¾ã€Œè§€æ¸¬ã€åˆ°ã€Œé è­¦ã€çš„é€²åŒ–ã€‚

- **å¾…è¾¦äº‹é … (Action Items):**
    - `[ ]` å°‡æœ€çµ‚ç¢ºèªçš„ PromQL æŸ¥è©¢æ›´æ–°åˆ°ç”Ÿç”¢ç’°å¢ƒçš„ Grafana å„€è¡¨æ¿ã€‚
    - `[ ]` æ ¹æ“š Burn-rate ç†è«–ï¼Œåœ¨ Prometheus ä¸­å»ºç«‹é›™æ™‚é–“çª—å‘Šè­¦è¦å‰‡ (Fast Burn / Slow Burn)ã€‚
    - `[ ]` å»ºç«‹ä¸€å€‹ã€Œç„¡æµé‡ã€å‘Šè­¦ï¼Œä»¥ç›£æ§æ—¥èªŒç™¼é€éˆè·¯æ˜¯å¦ä¸­æ–·ã€‚
    - `[ ]` ç‚º `Ingester` å’Œ `Compactor` å»ºç«‹å…§éƒ¨å¥åº·ç‹€æ³çš„ç›£æ§é¢æ¿ã€‚