name: Progress Blocks

on:
  # æ¯æ¬¡ä½ æŽ¨ä¸€ç¯‡ç­†è¨˜ï¼ˆdocs/**ï¼‰å°± +1
  push:
    paths:
      - "docs/**"
      - "1_Engineering_Craft/**"
      - "2_Thinking_Tools/**"
      - "3_Personal_Growth/**"
  # ä¹Ÿå¯æ‰‹å‹•æŒ‰éˆ• +n
  workflow_dispatch:
    inputs:
      units:
        description: "How many blocks to add"
        required: false
        default: "1"

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Taipei
      UNITS: ${{ github.event.inputs.units || 1 }}
      GRID_COLS: 20
      GRID_ROWS: 10
      CELL: 12
      GAP: 3
      COLOR_FILL: "#2ea043"
      COLOR_EMPTY: "#e5e7eb"
      MILESTONES: "50,100,200"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Update progress & render SVG
        run: node scripts/progress.mjs

      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(progress): update blocks"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Open milestone issue if hit
        if: hashFiles('data/.milestone_hit') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const n = fs.readFileSync('data/.milestone_hit', 'utf8').trim();
            const title = `ðŸŽ¯ Progress milestone reached: ${n} blocks`;
            const body = [
              `Great job! Total blocks reached **${n}**.`,
              '',
              '- [ ] Donate as planned (paste receipt/link)',
              '- [ ] Add a short reflection note to `growth/reflection/`',
              '',
              '> This issue was created automatically by Progress Blocks workflow.'
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['milestone','donation']
            });
