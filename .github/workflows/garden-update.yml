name: Garden Update (index + progress)

on:
  push:
    paths:
      - 'docs/**'
      - '1_Engineering_Craft/**'
      - '2_Thinking_Tools/**'
      - '3_Personal_Growth/**'
  workflow_dispatch:
    inputs:
      units:
        description: 'How many blocks to add'
        required: false
        default: '1'

permissions:
  contents: write
  issues: write

# 同一時間只跑一個，避免併發衝突
concurrency:
  group: garden-update
  cancel-in-progress: false

jobs:
  update:
    # 避免 bot 自己推回來又再觸發一次（防循環）
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Taipei
      UNITS: ${{ github.event.inputs.units || 1 }}
      GRID_COLS: 20
      GRID_ROWS: 10
      CELL: 12
      GAP: 3
      COLOR_FILL: '#2ea043'
      COLOR_EMPTY: '#e5e7eb'
      MILESTONES: '50,100,200'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      # 先產各分類 README 索引
      - name: Generate section index
        run: node scripts/gen-index.mjs

      # 再更新進度並畫 SVG（會產生 data/progress.json、assets/progress.svg、data/.milestone_hit）
      - name: Update progress & render SVG
        run: node scripts/progress.mjs

      # 一次把以上變更一起提交；先 rebase 再 push，避免非快轉
      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(garden): auto index & progress update [skip ci]"
            # 避免遠端較新導致被拒，先拉再推；簡單重試三次
            git pull --rebase origin "$GITHUB_REF_NAME" || true
            for i in 1 2 3; do
              git push && break
              echo "push failed, retry $i..."
              sleep 2
              git pull --rebase origin "$GITHUB_REF_NAME" || true
            done
          else
            echo "No changes to commit."
          fi

      # 只有打到里程碑時才會存在該檔案
      - name: Open milestone issue if hit
        if: hashFiles('data/.milestone_hit') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const n = fs.readFileSync('data/.milestone_hit', 'utf8').trim();
            const title = `🎯 Progress milestone reached: ${n} blocks`;
            const body = [
              `Great job! Total blocks reached **${n}**.`,
              '',
              '- [ ] Donate as planned (receipt/link)',
              '- [ ] Add a short reflection note to `growth/reflection/`',
              '',
              '> Created by Garden Update workflow.'
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['milestone','donation']
            });
