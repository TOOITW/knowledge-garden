name: Garden Update (index + progress)

on:
  push:
    paths:
      - 'docs/**'
      - '1_Engineering_Craft/**'
      - '2_Thinking_Tools/**'
      - '3_Personal_Growth/**'
  workflow_dispatch:
    inputs:
      units:
        description: 'How many blocks to add'
        required: false
        default: '1'

permissions:
  contents: write
  issues: write

# åŒä¸€æ™‚é–“åªè·‘ä¸€å€‹ï¼Œé¿å…ä½µç™¼è¡çª
concurrency:
  group: garden-update
  cancel-in-progress: false

jobs:
  update:
    # é¿å… bot è‡ªå·±æŽ¨å›žä¾†åˆå†è§¸ç™¼ä¸€æ¬¡ï¼ˆé˜²å¾ªç’°ï¼‰
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Taipei
      UNITS: ${{ github.event.inputs.units || 1 }}
      GRID_COLS: 20
      GRID_ROWS: 10
      CELL: 12
      GAP: 3
      COLOR_FILL: '#2ea043'
      COLOR_EMPTY: '#e5e7eb'
      MILESTONES: '50,100,200'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      # å…ˆç”¢å„åˆ†é¡ž README ç´¢å¼•
      - name: Generate section index
        run: node scripts/gen-index.mjs

      # å†æ›´æ–°é€²åº¦ä¸¦ç•« SVGï¼ˆæœƒç”¢ç”Ÿ data/progress.jsonã€assets/progress.svgã€data/.milestone_hitï¼‰
      - name: Update progress & render SVG
        run: node scripts/progress.mjs

      # ä¸€æ¬¡æŠŠä»¥ä¸Šè®Šæ›´ä¸€èµ·æäº¤ï¼›å…ˆ rebase å† pushï¼Œé¿å…éžå¿«è½‰
      - name: Commit changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(garden): auto index & progress update [skip ci]"
            # é¿å…é ç«¯è¼ƒæ–°å°Žè‡´è¢«æ‹’ï¼Œå…ˆæ‹‰å†æŽ¨ï¼›ç°¡å–®é‡è©¦ä¸‰æ¬¡
            git pull --rebase origin "$GITHUB_REF_NAME" || true
            for i in 1 2 3; do
              git push && break
              echo "push failed, retry $i..."
              sleep 2
              git pull --rebase origin "$GITHUB_REF_NAME" || true
            done
          else
            echo "No changes to commit."
          fi

      # åªæœ‰æ‰“åˆ°é‡Œç¨‹ç¢‘æ™‚æ‰æœƒå­˜åœ¨è©²æª”æ¡ˆ
      - name: Open milestone issue if hit
        if: hashFiles('data/.milestone_hit') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const n = fs.readFileSync('data/.milestone_hit', 'utf8').trim();
            const title = `ðŸŽ¯ Progress milestone reached: ${n} blocks`;
            const body = [
              `Great job! Total blocks reached **${n}**.`,
              '',
              '- [ ] Donate as planned (receipt/link)',
              '- [ ] Add a short reflection note to `growth/reflection/`',
              '',
              '> Created by Garden Update workflow.'
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['milestone','donation']
            });
